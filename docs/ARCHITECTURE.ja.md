# TRIDENTアーキテクチャ

TRIDENTは、OpenStreetMapのデータと自然言語処理機能を組み合わせたAI駆動のインタラクティブスマートマップアシスタントです。このドキュメントではそのアーキテクチャとコンポーネントについて説明します。

## システム概要

TRIDENTは3層のアーキテクチャで構成されています：

### 1. 表層（Surface Layer）

表層は以下の役割を担います：
- ユーザーとの対話管理
- タスク達成に適切なアビリティの選択
- `loadTridentSurfaceChain`による実装
- 自然言語入力の処理とアクションの決定

### 2. 内層（Inner Layer）

内層は以下の機能を提供します：
- ユーザーと表層間の対話履歴の分析
- TRIDENT中間言語による地図コンテンツの指定
- 自然言語要件の構造化マップクエリへの変換
- 地図のスタイリングと視覚化パラメータの管理

### 3. 深層（Deep Layer）

深層は地理空間データの取得を担当します：
- AreaWithConcernに基づくOverpass APIクエリの生成
- TRIDENT中間言語の処理
- データ取得とキャッシュの管理
- OpenStreetMapデータの統合

## 技術実装

### コアコンポーネント

1. **マップインターフェース**
   - MapLibre GLを基盤として構築
   - 地図表示用のBaseMapコンポーネントを実装
   - 複数の地図スタイルとレイヤーをサポート

2. **データ管理**
   - OpenStreetMapデータ取得にOverpass APIを使用
   - 6時間のデフォルトキャッシュ期間を実装
   - OSMデータをGeoJSON形式に変換

3. **AI統合**
   - 自然言語処理にLangChainを活用
   - 地図固有の操作のためのカスタムチェーンを実装
   - 対話状態とコンテキストを管理

### データフロー

1. ユーザー入力 → 表層
   - 自然言語処理
   - アビリティ選択
   - コンテキスト管理

2. 表層 → 内層
   - 対話履歴分析
   - TRIDENT中間言語の生成
   - 地図仕様の作成

3. 内層 → 深層
   - クエリ生成
   - データ取得
   - キャッシュ管理

4. 深層 → ユーザーインターフェース
   - 地図レンダリング
   - データ可視化
   - ユーザー操作の処理

## 主要技術

- **フロントエンド**: Next.js, React, TypeScript
- **地図レンダリング**: MapLibre GL
- **データソース**: OpenStreetMap, Overpass API
- **AI/ML**: LangChain
- **状態管理**: React Hooks
- **キャッシュ**: タイムスタンプベースの無効化を伴うローカルストレージ

## アーキテクチャの決定事項

1. **3層設計**
   - ユーザー操作、処理、データ取得の関心事を分離
   - モジュール化された開発とメンテナンスを実現
   - 複数言語インターフェースをサポート

2. **キャッシュ戦略**
   - OpenStreetMapの更新サイクルに合わせた6時間のキャッシュ期間
   - Overpass APIへの負荷を軽減
   - 頻繁なクエリに対するレスポンスタイムを改善

3. **コンポーネント構造**
   - メンテナンス性を考慮したモジュラーコンポーネント
   - 地図と対話インターフェースの分離
   - 再利用可能なユーティリティとツール

## 今後の展望

1. **拡張性**
   - `langchain/tools`への追加言語ツール
   - 地理空間処理機能の強化
   - 新しい地図視覚化スタイル

2. **パフォーマンス最適化**
   - キャッシュ戦略の改善
   - クエリ最適化
   - レスポンスタイムの改善

3. **機能拡張**
   - 追加の地図データソース
   - 自然言語理解の強化
   - 視覚化機能の拡張
